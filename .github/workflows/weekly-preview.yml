name: Weekly Preview Release

on:
  schedule:
    # Every Monday at 9am UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:

permissions:
  contents: write

env:
  # This workflow currently ships preview builds. Stable support is wired by
  # channel-aware metadata below and can be enabled in a future workflow by
  # setting this to "stable".
  RELEASE_CHANNEL: preview

jobs:
  version:
    name: Compute release metadata
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.meta.outputs.version }}
      release_tag: ${{ steps.meta.outputs.release_tag }}
      release_name: ${{ steps.meta.outputs.release_name }}
      release_body: ${{ steps.meta.outputs.release_body }}
      is_prerelease: ${{ steps.meta.outputs.is_prerelease }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute version and release metadata
        id: meta
        run: |
          CURRENT_VERSION=$(python - <<'PY'
          import pathlib, re
          content = pathlib.Path("crates/runt/Cargo.toml").read_text()
          match = re.search(r'^version\s*=\s*"([^"]+)"', content, re.MULTILINE)
          if not match:
              raise SystemExit("Could not find version in crates/runt/Cargo.toml")
          print(match.group(1))
          PY
          )
          COMMIT_SHA="${GITHUB_SHA::7}"

          if [ "${RELEASE_CHANNEL}" = "preview" ]; then
            VERSION="${CURRENT_VERSION}-preview.${GITHUB_RUN_NUMBER}+${COMMIT_SHA}"
            IS_PRERELEASE="true"
          else
            VERSION="${CURRENT_VERSION}"
            IS_PRERELEASE="false"
          fi

          RELEASE_TAG="${RELEASE_CHANNEL}"
          RELEASE_NAME="nteract ${RELEASE_CHANNEL} v${VERSION}"

          {
            echo "version=${VERSION}"
            echo "release_tag=${RELEASE_TAG}"
            echo "release_name=${RELEASE_NAME}"
            echo "is_prerelease=${IS_PRERELEASE}"
            echo "release_body<<EOF"
            echo "## ${RELEASE_CHANNEL^} channel release"
            echo
            echo "Automated ${RELEASE_CHANNEL} build from \`main\`."
            echo
            echo "- Commit: \`${GITHUB_SHA}\`"
            echo "- Version: \`${VERSION}\`"
            echo "- Update channel tag: \`${RELEASE_TAG}\`"
            echo
            echo "### nteract (desktop app)"
            echo
            echo "| Platform | Architecture | Download |"
            echo "|----------|--------------|----------|"
            echo "| macOS | ARM64 (Apple Silicon) | DMG asset |"
            echo "| macOS | x64 (Intel) | DMG asset |"
            echo "| Windows | x64 | NSIS installer asset |"
            echo "| Linux | x64 | AppImage asset |"
            echo
            echo "Updater metadata is published as \`latest.json\` on this release tag."
            echo
            echo "### runt (CLI)"
            echo
            echo "Standalone CLI binaries are uploaded to this release after app bundles finish."
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

  build-linux:
    name: Build Linux Executables
    runs-on: ubuntu-22.04
    needs: [version]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Rust
        uses: dsherret/rust-toolchain-file@v1

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "linux-release"

      - name: Build for Linux x64
        run: cargo build --release --target x86_64-unknown-linux-gnu -p runt-cli

      - name: Rename binaries
        run: |
          cp target/x86_64-unknown-linux-gnu/release/runt runt-linux-x64
          chmod +x runt-linux-x64

      - name: Upload Linux executables
        uses: actions/upload-artifact@v4
        with:
          name: runt-linux-executables
          path: |
            runt-linux-x64

  build-macos:
    name: Build macOS Executables
    runs-on: macos-latest
    needs: [version]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Rust
        uses: dsherret/rust-toolchain-file@v1

      - name: Install cross-compilation targets
        run: rustup target add x86_64-apple-darwin aarch64-apple-darwin

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "macos-release"

      - name: Build for macOS x64
        run: cargo build --release --target x86_64-apple-darwin -p runt-cli

      - name: Build for macOS ARM64
        run: cargo build --release --target aarch64-apple-darwin -p runt-cli

      - name: Rename binaries
        run: |
          cp target/x86_64-apple-darwin/release/runt runt-darwin-x64
          cp target/aarch64-apple-darwin/release/runt runt-darwin-arm64
          chmod +x runt-darwin-x64 runt-darwin-arm64

      - name: Upload macOS executables
        uses: actions/upload-artifact@v4
        with:
          name: runt-macos-executables
          path: |
            runt-darwin-x64
            runt-darwin-arm64

  build-notebook-linux-x64:
    name: Build Linux x64 Notebook AppImage
    runs-on: ubuntu-22.04
    needs: [version]
    outputs:
      release_id: ${{ steps.tauri.outputs.releaseId }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libxdo-dev \
            libssl-dev libayatana-appindicator3-dev librsvg2-dev patchelf

      - name: Set up Rust
        uses: dsherret/rust-toolchain-file@v1

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "linux-notebook-x64"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable corepack
        run: corepack enable

      - name: Set pnpm store directory
        run: pnpm config set store-dir ~/.pnpm-store

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install JS dependencies
        run: pnpm install

      - name: Build frontend
        run: pnpm build

      - name: Configure notebook release metadata
        env:
          APP_VERSION: ${{ needs.version.outputs.version }}
          UPDATE_CHANNEL: ${{ env.RELEASE_CHANNEL }}
          TAURI_UPDATER_PUBLIC_KEY: ${{ vars.TAURI_UPDATER_PUBLIC_KEY || secrets.TAURI_UPDATER_PUBLIC_KEY }}
        run: |
          if [ -z "$TAURI_UPDATER_PUBLIC_KEY" ]; then
            echo "TAURI_UPDATER_PUBLIC_KEY must be set as a repository variable or secret."
            exit 1
          fi

          python - <<'PY'
          import json, os, pathlib
          path = pathlib.Path("crates/notebook/tauri.conf.json")
          data = json.loads(path.read_text())
          data["version"] = os.environ["APP_VERSION"]
          plugins = data.setdefault("plugins", {})
          updater = plugins.setdefault("updater", {})
          updater["endpoints"] = [
              f"https://github.com/nteract/desktop/releases/download/{os.environ['UPDATE_CHANNEL']}/latest.json"
          ]
          updater["pubkey"] = os.environ["TAURI_UPDATER_PUBLIC_KEY"]
          path.write_text(json.dumps(data, indent=2) + "\n")
          PY

      - name: Generate Icons
        run: cargo xtask icons

      - name: Build external binaries
        run: |
          cargo build --release -p runtimed -p runt-cli
          TARGET=$(rustc --print host-tuple)
          mkdir -p crates/notebook/binaries
          cp target/release/runtimed "crates/notebook/binaries/runtimed-$TARGET"
          cp target/release/runt "crates/notebook/binaries/runt-$TARGET"

      - name: Build and upload Linux bundle with updater metadata
        id: tauri
        uses: tauri-apps/tauri-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          projectPath: crates/notebook
          tagName: ${{ needs.version.outputs.release_tag }}
          releaseName: ${{ needs.version.outputs.release_name }}
          releaseBody: ${{ needs.version.outputs.release_body }}
          releaseDraft: false
          prerelease: ${{ needs.version.outputs.is_prerelease }}
          uploadUpdaterJson: true
          updaterJsonPreferNsis: true
          args: >-
            --ci --bundles appimage --config '{"build":{"beforeBuildCommand":""}}'

  build-notebook-macos-arm64:
    name: Build macOS ARM64 Notebook DMG
    runs-on: macos-latest
    needs: [version, build-notebook-linux-x64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Rust
        uses: dsherret/rust-toolchain-file@v1

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "macos-notebook-arm64"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable corepack
        run: corepack enable

      - name: Set pnpm store directory
        run: pnpm config set store-dir ~/.pnpm-store

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install JS dependencies
        run: pnpm install

      - name: Build frontend
        run: pnpm build

      - name: Configure notebook release metadata
        env:
          APP_VERSION: ${{ needs.version.outputs.version }}
          UPDATE_CHANNEL: ${{ env.RELEASE_CHANNEL }}
          TAURI_UPDATER_PUBLIC_KEY: ${{ vars.TAURI_UPDATER_PUBLIC_KEY || secrets.TAURI_UPDATER_PUBLIC_KEY }}
        run: |
          if [ -z "$TAURI_UPDATER_PUBLIC_KEY" ]; then
            echo "TAURI_UPDATER_PUBLIC_KEY must be set as a repository variable or secret."
            exit 1
          fi

          python - <<'PY'
          import json, os, pathlib
          path = pathlib.Path("crates/notebook/tauri.conf.json")
          data = json.loads(path.read_text())
          data["version"] = os.environ["APP_VERSION"]
          plugins = data.setdefault("plugins", {})
          updater = plugins.setdefault("updater", {})
          updater["endpoints"] = [
              f"https://github.com/nteract/desktop/releases/download/{os.environ['UPDATE_CHANNEL']}/latest.json"
          ]
          updater["pubkey"] = os.environ["TAURI_UPDATER_PUBLIC_KEY"]
          path.write_text(json.dumps(data, indent=2) + "\n")
          PY

      - name: Import Apple signing certificate
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          if [ -z "$APPLE_CERTIFICATE" ]; then
            echo "No signing certificate configured, skipping"
            exit 0
          fi

          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "$APPLE_CERTIFICATE" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 \
            -P "$APPLE_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"

          security list-keychain -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          rm $RUNNER_TEMP/certificate.p12

          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV

      - name: Generate Icons
        run: cargo xtask icons

      - name: Build external binaries
        run: |
          cargo build --release -p runtimed -p runt-cli
          TARGET=$(rustc --print host-tuple)
          mkdir -p crates/notebook/binaries
          cp target/release/runtimed "crates/notebook/binaries/runtimed-$TARGET"
          cp target/release/runt "crates/notebook/binaries/runt-$TARGET"

      - name: Build and upload macOS ARM64 bundle with updater metadata
        uses: tauri-apps/tauri-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        with:
          projectPath: crates/notebook
          releaseId: ${{ needs.build-notebook-linux-x64.outputs.release_id }}
          tagName: ${{ needs.version.outputs.release_tag }}
          releaseDraft: false
          prerelease: ${{ needs.version.outputs.is_prerelease }}
          uploadUpdaterJson: true
          updaterJsonPreferNsis: true
          args: >-
            --ci --bundles dmg --config '{"build":{"beforeBuildCommand":""}}'

      - name: Cleanup keychain
        if: always()
        run: |
          if [ -n "$KEYCHAIN_PATH" ] && [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH" || true
          fi

  build-notebook-macos-x64:
    name: Build macOS x64 Notebook DMG
    runs-on: macos-latest
    needs: [version, build-notebook-linux-x64, build-notebook-macos-arm64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Rust
        uses: dsherret/rust-toolchain-file@v1

      - name: Add x64 target for cross-compilation
        run: rustup target add x86_64-apple-darwin

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "macos-notebook-x64"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable corepack
        run: corepack enable

      - name: Set pnpm store directory
        run: pnpm config set store-dir ~/.pnpm-store

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install JS dependencies
        run: pnpm install

      - name: Build frontend
        run: pnpm build

      - name: Configure notebook release metadata
        env:
          APP_VERSION: ${{ needs.version.outputs.version }}
          UPDATE_CHANNEL: ${{ env.RELEASE_CHANNEL }}
          TAURI_UPDATER_PUBLIC_KEY: ${{ vars.TAURI_UPDATER_PUBLIC_KEY || secrets.TAURI_UPDATER_PUBLIC_KEY }}
        run: |
          if [ -z "$TAURI_UPDATER_PUBLIC_KEY" ]; then
            echo "TAURI_UPDATER_PUBLIC_KEY must be set as a repository variable or secret."
            exit 1
          fi

          python - <<'PY'
          import json, os, pathlib
          path = pathlib.Path("crates/notebook/tauri.conf.json")
          data = json.loads(path.read_text())
          data["version"] = os.environ["APP_VERSION"]
          plugins = data.setdefault("plugins", {})
          updater = plugins.setdefault("updater", {})
          updater["endpoints"] = [
              f"https://github.com/nteract/desktop/releases/download/{os.environ['UPDATE_CHANNEL']}/latest.json"
          ]
          updater["pubkey"] = os.environ["TAURI_UPDATER_PUBLIC_KEY"]
          path.write_text(json.dumps(data, indent=2) + "\n")
          PY

      - name: Import Apple signing certificate
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          if [ -z "$APPLE_CERTIFICATE" ]; then
            echo "No signing certificate configured, skipping"
            exit 0
          fi

          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "$APPLE_CERTIFICATE" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 \
            -P "$APPLE_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"

          security list-keychain -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          rm $RUNNER_TEMP/certificate.p12

          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV

      - name: Generate Icons
        run: cargo xtask icons

      - name: Build external binaries
        run: |
          cargo build --release -p runtimed -p runt-cli --target x86_64-apple-darwin
          mkdir -p crates/notebook/binaries
          cp target/x86_64-apple-darwin/release/runtimed "crates/notebook/binaries/runtimed-x86_64-apple-darwin"
          cp target/x86_64-apple-darwin/release/runt "crates/notebook/binaries/runt-x86_64-apple-darwin"

      - name: Build and upload macOS x64 bundle with updater metadata
        uses: tauri-apps/tauri-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        with:
          projectPath: crates/notebook
          releaseId: ${{ needs.build-notebook-linux-x64.outputs.release_id }}
          tagName: ${{ needs.version.outputs.release_tag }}
          releaseDraft: false
          prerelease: ${{ needs.version.outputs.is_prerelease }}
          uploadUpdaterJson: true
          updaterJsonPreferNsis: true
          args: >-
            --ci --target x86_64-apple-darwin --bundles dmg --config '{"build":{"beforeBuildCommand":""}}'

      - name: Cleanup keychain
        if: always()
        run: |
          if [ -n "$KEYCHAIN_PATH" ] && [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH" || true
          fi

  build-notebook-windows-x64:
    name: Build Windows x64 Notebook Installer
    runs-on: windows-latest
    needs: [version, build-notebook-linux-x64, build-notebook-macos-x64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Rust
        uses: dsherret/rust-toolchain-file@v1

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "windows-notebook-x64"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable corepack
        run: corepack enable

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pnpm\store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install JS dependencies
        run: pnpm install

      - name: Build frontend
        run: pnpm build

      - name: Configure notebook release metadata
        shell: bash
        env:
          APP_VERSION: ${{ needs.version.outputs.version }}
          UPDATE_CHANNEL: ${{ env.RELEASE_CHANNEL }}
          TAURI_UPDATER_PUBLIC_KEY: ${{ vars.TAURI_UPDATER_PUBLIC_KEY || secrets.TAURI_UPDATER_PUBLIC_KEY }}
        run: |
          if [ -z "$TAURI_UPDATER_PUBLIC_KEY" ]; then
            echo "TAURI_UPDATER_PUBLIC_KEY must be set as a repository variable or secret."
            exit 1
          fi

          python - <<'PY'
          import json, os, pathlib
          path = pathlib.Path("crates/notebook/tauri.conf.json")
          data = json.loads(path.read_text())
          data["version"] = os.environ["APP_VERSION"]
          plugins = data.setdefault("plugins", {})
          updater = plugins.setdefault("updater", {})
          updater["endpoints"] = [
              f"https://github.com/nteract/desktop/releases/download/{os.environ['UPDATE_CHANNEL']}/latest.json"
          ]
          updater["pubkey"] = os.environ["TAURI_UPDATER_PUBLIC_KEY"]
          path.write_text(json.dumps(data, indent=2) + "\n")
          PY

      - name: Generate Icons
        run: cargo xtask icons

      - name: Build external binaries
        shell: bash
        run: |
          cargo build --release -p runtimed -p runt-cli
          TARGET=$(rustc --print host-tuple)
          mkdir -p crates/notebook/binaries
          cp target/release/runtimed.exe "crates/notebook/binaries/runtimed-$TARGET.exe"
          cp target/release/runt.exe "crates/notebook/binaries/runt-$TARGET.exe"

      - name: Build and upload Windows bundle with updater metadata
        uses: tauri-apps/tauri-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          projectPath: crates/notebook
          releaseId: ${{ needs.build-notebook-linux-x64.outputs.release_id }}
          tagName: ${{ needs.version.outputs.release_tag }}
          releaseDraft: false
          prerelease: ${{ needs.version.outputs.is_prerelease }}
          uploadUpdaterJson: true
          updaterJsonPreferNsis: true
          args: >-
            --ci --bundles nsis --config '{"build":{"beforeBuildCommand":""}}'

  release-runt-cli:
    name: Upload runt CLI binaries to release
    runs-on: ubuntu-latest
    needs:
      [
        version,
        build-linux,
        build-macos,
        build-notebook-windows-x64,
      ]
    steps:
      - name: Download Linux executables
        uses: actions/download-artifact@v4
        with:
          name: runt-linux-executables
          path: ./executables

      - name: Download macOS executables
        uses: actions/download-artifact@v4
        with:
          name: runt-macos-executables
          path: ./executables

      - name: Upload CLI binaries to release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.version.outputs.release_tag }}
          draft: false
          prerelease: ${{ needs.version.outputs.is_prerelease }}
          overwrite_files: true
          files: |
            ./executables/runt-linux-x64
            ./executables/runt-darwin-x64
            ./executables/runt-darwin-arm64
