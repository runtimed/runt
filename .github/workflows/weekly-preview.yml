name: Weekly Preview Release

on:
  schedule:
    # Every Monday at 9am UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-linux:
    name: Build Linux Executables
    runs-on: ubuntu-22.04
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libxdo-dev \
            libssl-dev libayatana-appindicator3-dev librsvg2-dev

      - name: Set up Rust
        uses: dsherret/rust-toolchain-file@v1

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "linux-release"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable corepack
        run: corepack enable

      - name: Set pnpm store directory
        run: pnpm config set store-dir ~/.pnpm-store

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install JS dependencies
        run: pnpm install

      - name: Build sidecar UI
        run: pnpm build

      - name: Set version
        id: version
        run: |
          CURRENT_VERSION=$(grep '^version' crates/runt/Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          COMMIT_SHA=${GITHUB_SHA::7}
          VERSION="${CURRENT_VERSION}-preview.${COMMIT_SHA}"
          echo "Setting version to: ${VERSION}"
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

          # Update version in Cargo.toml
          sed -i "s/^version = .*/version = \"${VERSION}\"/" crates/runt/Cargo.toml

      - name: Build for Linux x64
        run: cargo build --release --target x86_64-unknown-linux-gnu -p runt-cli

      - name: Rename binaries
        run: |
          cp target/x86_64-unknown-linux-gnu/release/runt runt-linux-x64
          chmod +x runt-linux-x64

      - name: Upload Linux executables
        uses: actions/upload-artifact@v4
        with:
          name: runt-linux-executables
          path: |
            runt-linux-x64

  build-macos:
    name: Build macOS Executables
    runs-on: macos-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Rust
        uses: dsherret/rust-toolchain-file@v1

      - name: Install cross-compilation targets
        run: rustup target add x86_64-apple-darwin aarch64-apple-darwin

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "macos-release"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable corepack
        run: corepack enable

      - name: Set pnpm store directory
        run: pnpm config set store-dir ~/.pnpm-store

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install JS dependencies
        run: pnpm install

      - name: Build sidecar UI
        run: pnpm build

      - name: Set version in Cargo.toml
        id: version
        run: |
          CURRENT_VERSION=$(grep '^version' crates/runt/Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          COMMIT_SHA=${GITHUB_SHA::7}
          VERSION="${CURRENT_VERSION}-preview.${COMMIT_SHA}"
          echo "Setting version to: ${VERSION}"
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          sed -i '' "s/^version = .*/version = \"${VERSION}\"/" crates/runt/Cargo.toml

      - name: Build for macOS x64
        run: cargo build --release --target x86_64-apple-darwin -p runt-cli

      - name: Build for macOS ARM64
        run: cargo build --release --target aarch64-apple-darwin -p runt-cli

      - name: Rename binaries
        run: |
          cp target/x86_64-apple-darwin/release/runt runt-darwin-x64
          cp target/aarch64-apple-darwin/release/runt runt-darwin-arm64
          chmod +x runt-darwin-x64 runt-darwin-arm64

      - name: Upload macOS executables
        uses: actions/upload-artifact@v4
        with:
          name: runt-macos-executables
          path: |
            runt-darwin-x64
            runt-darwin-arm64

  build-notebook-macos-arm64:
    name: Build macOS ARM64 Notebook DMG
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Rust
        uses: dsherret/rust-toolchain-file@v1

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "macos-notebook-arm64"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable corepack
        run: corepack enable

      - name: Set pnpm store directory
        run: pnpm config set store-dir ~/.pnpm-store

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install JS dependencies
        run: pnpm install

      - name: Build frontend
        run: pnpm build

      - name: Cache cargo bin
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin
          key: cargo-bin-macos-arm64-tauri-cli-${{ hashFiles('rust-toolchain.toml') }}
          restore-keys: |
            cargo-bin-macos-arm64-tauri-cli-

      - name: Install Tauri CLI
        run: |
          if ! command -v cargo-tauri &> /dev/null; then
            cargo install tauri-cli --locked
          fi

      - name: Import Apple signing certificate
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          if [ -z "$APPLE_CERTIFICATE" ]; then
            echo "No signing certificate configured, skipping"
            exit 0
          fi

          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "$APPLE_CERTIFICATE" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 \
            -P "$APPLE_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"

          security list-keychain -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          rm $RUNNER_TEMP/certificate.p12

          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV

      - name: Set version in tauri.conf.json
        run: |
          CURRENT_VERSION=$(grep '^version' crates/runt/Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          COMMIT_SHA=${GITHUB_SHA::7}
          VERSION="${CURRENT_VERSION}-preview.${COMMIT_SHA}"
          echo "Setting version to: ${VERSION}"
          sed -i '' "s/\"version\": \"[^\"]*\"/\"version\": \"${VERSION}\"/" crates/notebook/tauri.conf.json

      - name: Generate Icons
        run: cargo xtask icons

      - name: Build external binaries
        run: |
          cargo build --release -p runtimed -p runt-cli
          TARGET=$(rustc --print host-tuple)
          mkdir -p crates/notebook/binaries
          cp target/release/runtimed "crates/notebook/binaries/runtimed-$TARGET"
          cp target/release/runt "crates/notebook/binaries/runt-$TARGET"

      - name: Build and Sign DMG
        env:
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: cargo tauri build --ci --bundles dmg --config '{"build":{"beforeBuildCommand":""}}'
        working-directory: crates/notebook

      - name: Cleanup keychain
        if: always()
        run: |
          if [ -n "$KEYCHAIN_PATH" ] && [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH" || true
          fi

      - name: Rename DMG
        run: |
          DMG_PATH=$(find target/release/bundle/dmg -name "*.dmg" | head -1)
          cp "$DMG_PATH" nteract-darwin-arm64.dmg

      - name: Upload ARM64 DMG
        uses: actions/upload-artifact@v4
        with:
          name: nteract-macos-arm64
          path: nteract-darwin-arm64.dmg

  build-notebook-macos-x64:
    name: Build macOS x64 Notebook DMG
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Rust
        uses: dsherret/rust-toolchain-file@v1

      - name: Add x64 target for cross-compilation
        run: rustup target add x86_64-apple-darwin

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "macos-notebook-x64"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable corepack
        run: corepack enable

      - name: Set pnpm store directory
        run: pnpm config set store-dir ~/.pnpm-store

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install JS dependencies
        run: pnpm install

      - name: Build frontend
        run: pnpm build

      - name: Cache cargo bin
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin
          key: cargo-bin-macos-x64-tauri-cli-${{ hashFiles('rust-toolchain.toml') }}
          restore-keys: |
            cargo-bin-macos-x64-tauri-cli-

      - name: Install Tauri CLI
        run: |
          if ! command -v cargo-tauri &> /dev/null; then
            cargo install tauri-cli --locked
          fi

      - name: Import Apple signing certificate
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          if [ -z "$APPLE_CERTIFICATE" ]; then
            echo "No signing certificate configured, skipping"
            exit 0
          fi

          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "$APPLE_CERTIFICATE" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 \
            -P "$APPLE_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"

          security list-keychain -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          rm $RUNNER_TEMP/certificate.p12

          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV

      - name: Set version in tauri.conf.json
        run: |
          CURRENT_VERSION=$(grep '^version' crates/runt/Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          COMMIT_SHA=${GITHUB_SHA::7}
          VERSION="${CURRENT_VERSION}-preview.${COMMIT_SHA}"
          echo "Setting version to: ${VERSION}"
          sed -i '' "s/\"version\": \"[^\"]*\"/\"version\": \"${VERSION}\"/" crates/notebook/tauri.conf.json

      - name: Generate Icons
        run: cargo xtask icons

      - name: Build external binaries
        run: |
          cargo build --release -p runtimed -p runt-cli --target x86_64-apple-darwin
          mkdir -p crates/notebook/binaries
          cp target/x86_64-apple-darwin/release/runtimed "crates/notebook/binaries/runtimed-x86_64-apple-darwin"
          cp target/x86_64-apple-darwin/release/runt "crates/notebook/binaries/runt-x86_64-apple-darwin"

      - name: Build and Sign DMG
        env:
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: cargo tauri build --ci --target x86_64-apple-darwin --bundles dmg --config '{"build":{"beforeBuildCommand":""}}'
        working-directory: crates/notebook

      - name: Cleanup keychain
        if: always()
        run: |
          if [ -n "$KEYCHAIN_PATH" ] && [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH" || true
          fi

      - name: Rename DMG
        run: |
          DMG_PATH=$(find target/x86_64-apple-darwin/release/bundle/dmg -name "*.dmg" | head -1)
          cp "$DMG_PATH" nteract-darwin-x64.dmg

      - name: Upload x64 DMG
        uses: actions/upload-artifact@v4
        with:
          name: nteract-macos-x64
          path: nteract-darwin-x64.dmg

  build-notebook-windows-x64:
    name: Build Windows x64 Notebook Installer
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Rust
        uses: dsherret/rust-toolchain-file@v1

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "windows-notebook-x64"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable corepack
        run: corepack enable

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pnpm\store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install JS dependencies
        run: pnpm install

      - name: Build frontend
        run: pnpm build

      - name: Cache cargo bin
        uses: actions/cache@v4
        with:
          path: ~\.cargo\bin
          key: cargo-bin-windows-x64-tauri-cli-${{ hashFiles('rust-toolchain.toml') }}
          restore-keys: |
            cargo-bin-windows-x64-tauri-cli-

      - name: Install Tauri CLI
        shell: pwsh
        run: |
          if (!(Get-Command cargo-tauri -ErrorAction SilentlyContinue)) {
            cargo install tauri-cli --locked
          }

      - name: Set version in tauri.conf.json
        shell: pwsh
        run: |
          $content = Get-Content crates/runt/Cargo.toml -Raw
          if ($content -match 'version = "([^"]+)"') {
            $currentVersion = $matches[1]
          }
          $commitSha = "$env:GITHUB_SHA".Substring(0, 7)
          $version = "$currentVersion-preview.$commitSha"
          Write-Host "Setting version to: $version"
          $tauriConf = Get-Content crates/notebook/tauri.conf.json -Raw
          $tauriConf = $tauriConf -replace '"version": "[^"]+"', "`"version`": `"$version`""
          Set-Content crates/notebook/tauri.conf.json $tauriConf

      - name: Generate Icons
        run: cargo xtask icons

      - name: Build external binaries
        shell: bash
        run: |
          cargo build --release -p runtimed -p runt-cli
          TARGET=$(rustc --print host-tuple)
          mkdir -p crates/notebook/binaries
          cp target/release/runtimed.exe "crates/notebook/binaries/runtimed-$TARGET.exe"
          cp target/release/runt.exe "crates/notebook/binaries/runt-$TARGET.exe"

      - name: Build NSIS Installer
        run: cargo tauri build --ci --bundles nsis --config '{"build":{"beforeBuildCommand":""}}'
        working-directory: crates/notebook

      - name: Rename Installer
        shell: pwsh
        run: |
          $nsisPath = Get-ChildItem -Path target\release\bundle\nsis -Filter "*.exe" | Select-Object -First 1
          Copy-Item $nsisPath.FullName "nteract-windows-x64.exe"

      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: nteract-windows-x64
          path: nteract-windows-x64.exe

  build-notebook-linux-x64:
    name: Build Linux x64 Notebook AppImage
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libxdo-dev \
            libssl-dev libayatana-appindicator3-dev librsvg2-dev

      - name: Set up Rust
        uses: dsherret/rust-toolchain-file@v1

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "linux-notebook-x64"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable corepack
        run: corepack enable

      - name: Set pnpm store directory
        run: pnpm config set store-dir ~/.pnpm-store

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install JS dependencies
        run: pnpm install

      - name: Build frontend
        run: pnpm build

      - name: Cache cargo bin
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin
          key: cargo-bin-linux-x64-tauri-cli-${{ hashFiles('rust-toolchain.toml') }}
          restore-keys: |
            cargo-bin-linux-x64-tauri-cli-

      - name: Install Tauri CLI
        run: |
          if ! command -v cargo-tauri &> /dev/null; then
            cargo install tauri-cli --locked
          fi

      - name: Set version in tauri.conf.json
        run: |
          CURRENT_VERSION=$(grep '^version' crates/runt/Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          COMMIT_SHA=${GITHUB_SHA::7}
          VERSION="${CURRENT_VERSION}-preview.${COMMIT_SHA}"
          echo "Setting version to: ${VERSION}"
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"${VERSION}\"/" crates/notebook/tauri.conf.json

      - name: Generate Icons
        run: cargo xtask icons

      - name: Build external binaries
        run: |
          cargo build --release -p runtimed -p runt-cli
          TARGET=$(rustc --print host-tuple)
          mkdir -p crates/notebook/binaries
          cp target/release/runtimed "crates/notebook/binaries/runtimed-$TARGET"
          cp target/release/runt "crates/notebook/binaries/runt-$TARGET"

      - name: Build AppImage
        run: cargo tauri build --ci --bundles appimage --config '{"build":{"beforeBuildCommand":""}}'
        working-directory: crates/notebook

      - name: Rename AppImage
        run: |
          APPIMAGE_PATH=$(find target/release/bundle/appimage -name "*.AppImage" | head -1)
          cp "$APPIMAGE_PATH" nteract-linux-x64.AppImage

      - name: Upload Linux AppImage
        uses: actions/upload-artifact@v4
        with:
          name: nteract-linux-x64
          path: nteract-linux-x64.AppImage

  build-python-wheels:
    name: Build Python Wheels (${{ matrix.target }})
    runs-on: macos-latest
    strategy:
      matrix:
        target:
          - aarch64-apple-darwin
          - x86_64-apple-darwin
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dsherret/rust-toolchain-file@v1

      - name: Install cross-compilation targets
        run: rustup target add ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "python-${{ matrix.target }}"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable corepack
        run: corepack enable

      - name: Install JS dependencies
        run: pnpm install

      - name: Build sidecar UI
        run: pnpm build

      - name: Set dev version
        run: |
          CURRENT_VERSION=$(grep '^version' python/runtimed/pyproject.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          DEV_VERSION="${CURRENT_VERSION}.dev$(date -u +%Y%m%d)"
          echo "Setting Python version to: ${DEV_VERSION}"
          sed -i '' "s/^version = .*/version = \"${DEV_VERSION}\"/" python/runtimed/pyproject.toml

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist
          working-directory: python/runtimed
          sccache: true
          maturin-version: "v1.11.5"

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.target }}
          path: python/runtimed/dist

  prerelease:
    name: Prerelease
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    needs:
      [
        build-linux,
        build-macos,
        build-notebook-macos-arm64,
        build-notebook-macos-x64,
        build-notebook-windows-x64,
        build-notebook-linux-x64,
        build-python-wheels,
      ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Linux executables
        uses: actions/download-artifact@v4
        with:
          name: runt-linux-executables
          path: ./executables

      - name: Download macOS executables
        uses: actions/download-artifact@v4
        with:
          name: runt-macos-executables
          path: ./executables

      - name: Download macOS ARM64 notebook DMG
        uses: actions/download-artifact@v4
        with:
          name: nteract-macos-arm64
          path: ./executables

      - name: Download macOS x64 notebook DMG
        uses: actions/download-artifact@v4
        with:
          name: nteract-macos-x64
          path: ./executables

      - name: Download Windows x64 notebook installer
        uses: actions/download-artifact@v4
        with:
          name: nteract-windows-x64
          path: ./executables

      - name: Download Linux x64 notebook AppImage
        uses: actions/download-artifact@v4
        with:
          name: nteract-linux-x64
          path: ./executables

      - name: Download Python wheels (macOS ARM64)
        uses: actions/download-artifact@v4
        with:
          name: wheels-aarch64-apple-darwin
          path: ./wheels

      - name: Download Python wheels (macOS x64)
        uses: actions/download-artifact@v4
        with:
          name: wheels-x86_64-apple-darwin
          path: ./wheels

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Publish to PyPI
        continue-on-error: true
        run: uv publish --trusted-publishing always ./wheels/*.whl

      - name: Create GitHub Preview Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.build-linux.outputs.version }}
          name: nteract v${{ needs.build-linux.outputs.version }}
          body: |
            ## Weekly Preview Release

            Automated preview from `main`. **Commit:** ${{ github.sha }}

            ### nteract (desktop app)

            | Platform | Architecture | Download |
            |----------|--------------|----------|
            | macOS | ARM64 (Apple Silicon) | `nteract-darwin-arm64.dmg` |
            | macOS | x64 (Intel) | `nteract-darwin-x64.dmg` |
            | Windows | x64 | `nteract-windows-x64.exe` |
            | Linux | x64 | `nteract-linux-x64.AppImage` |

            macOS builds are signed and notarized. Windows is not code signed â€” expect a SmartScreen prompt. Linux AppImage: `chmod +x` and run.

            ### runt (CLI)

            Also bundled inside the desktop app. Standalone binaries:

            | Platform | Architecture | Download |
            |----------|--------------|----------|
            | Linux | x64 | `runt-linux-x64` |
            | macOS | x64 | `runt-darwin-x64` |
            | macOS | ARM64 | `runt-darwin-arm64` |

            ### runtimed (Python)

            ```bash
            pip install runtimed --pre
            ```
          draft: false
          prerelease: true
          files: |
            ./executables/runt-linux-x64
            ./executables/runt-darwin-x64
            ./executables/runt-darwin-arm64
            ./executables/nteract-linux-x64.AppImage
            ./executables/nteract-darwin-x64.dmg
            ./executables/nteract-darwin-arm64.dmg
            ./executables/nteract-windows-x64.exe
            ./wheels/*.whl
