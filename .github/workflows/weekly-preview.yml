name: Weekly Preview Release

on:
  schedule:
    # Every Monday at 9am UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:

permissions:
  contents: write

env:
  TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
  TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

jobs:
  build-linux:
    name: Build Linux Executables
    runs-on: ubuntu-22.04
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libxdo-dev \
            libssl-dev libayatana-appindicator3-dev librsvg2-dev

      - name: Set up Rust
        uses: dsherret/rust-toolchain-file@v1

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "linux-release"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable corepack
        run: corepack enable

      - name: Set pnpm store directory
        run: pnpm config set store-dir ~/.pnpm-store

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install JS dependencies
        run: pnpm install

      - name: Build sidecar UI
        run: pnpm build

      - name: Set version
        id: version
        run: |
          CURRENT_VERSION=$(grep '^version' crates/runt/Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          COMMIT_SHA=${GITHUB_SHA::7}
          VERSION="${CURRENT_VERSION}-preview.${COMMIT_SHA}"
          echo "Setting version to: ${VERSION}"
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

          # Update version in Cargo.toml
          sed -i "s/^version = .*/version = \"${VERSION}\"/" crates/runt/Cargo.toml

      - name: Build for Linux x64
        run: cargo build --release --target x86_64-unknown-linux-gnu -p runt-cli

      - name: Rename binaries
        run: |
          cp target/x86_64-unknown-linux-gnu/release/runt runt-linux-x64
          chmod +x runt-linux-x64

      - name: Upload Linux executables
        uses: actions/upload-artifact@v4
        with:
          name: runt-linux-executables
          path: |
            runt-linux-x64

  build-macos:
    name: Build macOS ARM64 Executables
    runs-on: macos-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Rust
        uses: dsherret/rust-toolchain-file@v1

      - name: Install cross-compilation target
        run: rustup target add aarch64-apple-darwin

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "macos-release"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable corepack
        run: corepack enable

      - name: Set pnpm store directory
        run: pnpm config set store-dir ~/.pnpm-store

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install JS dependencies
        run: pnpm install

      - name: Build sidecar UI
        run: pnpm build

      - name: Set version in Cargo.toml
        id: version
        run: |
          CURRENT_VERSION=$(grep '^version' crates/runt/Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          COMMIT_SHA=${GITHUB_SHA::7}
          VERSION="${CURRENT_VERSION}-preview.${COMMIT_SHA}"
          echo "Setting version to: ${VERSION}"
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          sed -i '' "s/^version = .*/version = \"${VERSION}\"/" crates/runt/Cargo.toml

      - name: Build for macOS ARM64
        run: cargo build --release --target aarch64-apple-darwin -p runt-cli

      - name: Rename binaries
        run: |
          cp target/aarch64-apple-darwin/release/runt runt-darwin-arm64
          chmod +x runt-darwin-arm64

      - name: Upload macOS executables
        uses: actions/upload-artifact@v4
        with:
          name: runt-macos-executables
          path: |
            runt-darwin-arm64

  build-notebook-macos-arm64:
    name: Build macOS ARM64 Notebook
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Rust
        uses: dsherret/rust-toolchain-file@v1

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "macos-notebook-arm64"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable corepack
        run: corepack enable

      - name: Set pnpm store directory
        run: pnpm config set store-dir ~/.pnpm-store

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install JS dependencies
        run: pnpm install

      - name: Build frontend
        run: pnpm build

      - name: Cache cargo bin
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin
          key: cargo-bin-macos-arm64-tauri-cli-${{ hashFiles('rust-toolchain.toml') }}
          restore-keys: |
            cargo-bin-macos-arm64-tauri-cli-

      - name: Install Tauri CLI
        run: |
          if ! command -v cargo-tauri &> /dev/null; then
            cargo install tauri-cli --locked
          fi

      - name: Import Apple signing certificate
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          if [ -z "$APPLE_CERTIFICATE" ]; then
            echo "No signing certificate configured, skipping"
            exit 0
          fi

          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "$APPLE_CERTIFICATE" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 \
            -P "$APPLE_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"

          security list-keychain -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          rm $RUNNER_TEMP/certificate.p12

          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV

      - name: Set version in tauri.conf.json
        run: |
          CURRENT_VERSION=$(grep '^version' crates/runt/Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          COMMIT_SHA=${GITHUB_SHA::7}
          VERSION="${CURRENT_VERSION}-preview.${COMMIT_SHA}"
          echo "Setting version to: ${VERSION}"
          sed -i '' "s/\"version\": \"[^\"]*\"/\"version\": \"${VERSION}\"/" crates/notebook/tauri.conf.json

      - name: Generate Icons
        run: cargo xtask icons

      - name: Build external binaries
        run: |
          cargo build --release -p runtimed -p runt-cli
          TARGET=$(rustc --print host-tuple)
          mkdir -p crates/notebook/binaries
          cp target/release/runtimed "crates/notebook/binaries/runtimed-$TARGET"
          cp target/release/runt "crates/notebook/binaries/runt-$TARGET"

      - name: Build with tauri-action
        uses: tauri-apps/tauri-action@v0
        env:
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: crates/notebook
          args: --bundles dmg --config '{"build":{"beforeBuildCommand":""}}'
          includeUpdaterJson: false

      - name: Cleanup keychain
        if: always()
        run: |
          if [ -n "$KEYCHAIN_PATH" ] && [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH" || true
          fi

      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          DMG_PATH=$(find target/release/bundle/dmg -name "*.dmg" | head -1)
          cp "$DMG_PATH" artifacts/nteract-darwin-arm64.dmg
          # Updater bundle (.tar.gz and .sig)
          for f in target/release/bundle/macos/*.tar.gz; do
            [ -f "$f" ] && cp "$f" artifacts/nteract-darwin-arm64.app.tar.gz
          done
          for f in target/release/bundle/macos/*.tar.gz.sig; do
            [ -f "$f" ] && cp "$f" artifacts/nteract-darwin-arm64.app.tar.gz.sig
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nteract-macos-arm64
          path: artifacts/

  build-notebook-windows-x64:
    name: Build Windows x64 Notebook
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Rust
        uses: dsherret/rust-toolchain-file@v1

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "windows-notebook-x64"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable corepack
        run: corepack enable

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pnpm\store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install JS dependencies
        run: pnpm install

      - name: Build frontend
        run: pnpm build

      - name: Cache cargo bin
        uses: actions/cache@v4
        with:
          path: ~\.cargo\bin
          key: cargo-bin-windows-x64-tauri-cli-${{ hashFiles('rust-toolchain.toml') }}
          restore-keys: |
            cargo-bin-windows-x64-tauri-cli-

      - name: Install Tauri CLI
        shell: pwsh
        run: |
          if (!(Get-Command cargo-tauri -ErrorAction SilentlyContinue)) {
            cargo install tauri-cli --locked
          }

      - name: Set version in tauri.conf.json
        shell: pwsh
        run: |
          $content = Get-Content crates/runt/Cargo.toml -Raw
          if ($content -match 'version = "([^"]+)"') {
            $currentVersion = $matches[1]
          }
          $commitSha = "$env:GITHUB_SHA".Substring(0, 7)
          $version = "$currentVersion-preview.$commitSha"
          Write-Host "Setting version to: $version"
          $tauriConf = Get-Content crates/notebook/tauri.conf.json -Raw
          $tauriConf = $tauriConf -replace '"version": "[^"]+"', "`"version`": `"$version`""
          Set-Content crates/notebook/tauri.conf.json $tauriConf

      - name: Generate Icons
        run: cargo xtask icons

      - name: Build external binaries
        shell: bash
        run: |
          cargo build --release -p runtimed -p runt-cli
          TARGET=$(rustc --print host-tuple)
          mkdir -p crates/notebook/binaries
          cp target/release/runtimed.exe "crates/notebook/binaries/runtimed-$TARGET.exe"
          cp target/release/runt.exe "crates/notebook/binaries/runt-$TARGET.exe"

      - name: Build with tauri-action
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: crates/notebook
          args: --bundles nsis --config '{"build":{"beforeBuildCommand":""}}'
          includeUpdaterJson: false

      - name: Collect artifacts
        shell: bash
        run: |
          mkdir -p artifacts
          NSIS_PATH=$(find target/release/bundle/nsis -name "*.exe" | head -1)
          cp "$NSIS_PATH" artifacts/nteract-windows-x64.exe
          for f in target/release/bundle/nsis/*.nsis.zip; do
            [ -f "$f" ] && cp "$f" artifacts/nteract-windows-x64.nsis.zip
          done
          for f in target/release/bundle/nsis/*.nsis.zip.sig; do
            [ -f "$f" ] && cp "$f" artifacts/nteract-windows-x64.nsis.zip.sig
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nteract-windows-x64
          path: artifacts/

  build-notebook-linux-x64:
    name: Build Linux x64 Notebook
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libxdo-dev \
            libssl-dev libayatana-appindicator3-dev librsvg2-dev

      - name: Set up Rust
        uses: dsherret/rust-toolchain-file@v1

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "linux-notebook-x64"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable corepack
        run: corepack enable

      - name: Set pnpm store directory
        run: pnpm config set store-dir ~/.pnpm-store

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install JS dependencies
        run: pnpm install

      - name: Build frontend
        run: pnpm build

      - name: Cache cargo bin
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin
          key: cargo-bin-linux-x64-tauri-cli-${{ hashFiles('rust-toolchain.toml') }}
          restore-keys: |
            cargo-bin-linux-x64-tauri-cli-

      - name: Install Tauri CLI
        run: |
          if ! command -v cargo-tauri &> /dev/null; then
            cargo install tauri-cli --locked
          fi

      - name: Set version in tauri.conf.json
        run: |
          CURRENT_VERSION=$(grep '^version' crates/runt/Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          COMMIT_SHA=${GITHUB_SHA::7}
          VERSION="${CURRENT_VERSION}-preview.${COMMIT_SHA}"
          echo "Setting version to: ${VERSION}"
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"${VERSION}\"/" crates/notebook/tauri.conf.json

      - name: Generate Icons
        run: cargo xtask icons

      - name: Build external binaries
        run: |
          cargo build --release -p runtimed -p runt-cli
          TARGET=$(rustc --print host-tuple)
          mkdir -p crates/notebook/binaries
          cp target/release/runtimed "crates/notebook/binaries/runtimed-$TARGET"
          cp target/release/runt "crates/notebook/binaries/runt-$TARGET"

      - name: Build with tauri-action
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: crates/notebook
          args: --bundles appimage --config '{"build":{"beforeBuildCommand":""}}'
          includeUpdaterJson: false

      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          APPIMAGE_PATH=$(find target/release/bundle/appimage -name "*.AppImage" | head -1)
          cp "$APPIMAGE_PATH" artifacts/nteract-linux-x64.AppImage
          for f in target/release/bundle/appimage/*.AppImage.sig; do
            [ -f "$f" ] && cp "$f" artifacts/nteract-linux-x64.AppImage.sig
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nteract-linux-x64
          path: artifacts/

  build-python-wheels:
    name: Build Python Wheels (${{ matrix.platform.target }})
    runs-on: ${{ matrix.platform.runner }}
    strategy:
      matrix:
        platform:
          - runner: macos-latest
            target: aarch64-apple-darwin
          - runner: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - runner: windows-latest
            target: x86_64-pc-windows-msvc
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dsherret/rust-toolchain-file@v1

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "python-${{ matrix.platform.target }}"

      - name: Set dev version (Unix)
        if: runner.os != 'Windows'
        run: |
          CURRENT_VERSION=$(grep '^version' python/runtimed/pyproject.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          # Bump patch and use alpha tag so it sorts after current stable (PEP 440)
          MAJOR_MINOR=$(echo "$CURRENT_VERSION" | sed 's/\.[0-9]*$//')
          PATCH=$(echo "$CURRENT_VERSION" | grep -o '[0-9]*$')
          NEXT_PATCH=$((PATCH + 1))
          DEV_VERSION="${MAJOR_MINOR}.${NEXT_PATCH}a$(date -u +%Y%m%d)"
          echo "Setting Python version to: ${DEV_VERSION}"
          sed -i.bak "s/^version = .*/version = \"${DEV_VERSION}\"/" python/runtimed/pyproject.toml

      - name: Set dev version (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $content = Get-Content python/runtimed/pyproject.toml -Raw
          if ($content -match 'version = "([^"]+)"') {
            $currentVersion = $matches[1]
          }
          # Bump patch and use alpha tag so it sorts after current stable (PEP 440)
          $parts = $currentVersion.Split('.')
          $parts[2] = [string]([int]$parts[2] + 1)
          $nextVersion = $parts -join '.'
          $devVersion = "${nextVersion}a$(Get-Date -Format 'yyyyMMdd' -AsUTC)"
          Write-Host "Setting Python version to: $devVersion"
          $content = $content -replace 'version = "[^"]+"', "version = `"$devVersion`""
          Set-Content python/runtimed/pyproject.toml $content -NoNewline

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist
          working-directory: python/runtimed
          sccache: true
          maturin-version: "v1.11.5"

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.platform.target }}
          path: python/runtimed/dist

  prerelease:
    name: Prerelease
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    needs:
      [
        build-linux,
        build-macos,
        build-notebook-macos-arm64,
        build-notebook-windows-x64,
        build-notebook-linux-x64,
        build-python-wheels,
      ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Linux executables
        uses: actions/download-artifact@v4
        with:
          name: runt-linux-executables
          path: ./executables

      - name: Download macOS executables
        uses: actions/download-artifact@v4
        with:
          name: runt-macos-executables
          path: ./executables

      - name: Download macOS ARM64 notebook
        uses: actions/download-artifact@v4
        with:
          name: nteract-macos-arm64
          path: ./notebook-macos-arm64

      - name: Download Windows x64 notebook
        uses: actions/download-artifact@v4
        with:
          name: nteract-windows-x64
          path: ./notebook-windows-x64

      - name: Download Linux x64 notebook
        uses: actions/download-artifact@v4
        with:
          name: nteract-linux-x64
          path: ./notebook-linux-x64

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          # CLI binaries
          cp executables/runt-linux-x64 release-assets/
          cp executables/runt-darwin-arm64 release-assets/
          # Notebook installers
          cp notebook-macos-arm64/nteract-darwin-arm64.dmg release-assets/
          cp notebook-windows-x64/nteract-windows-x64.exe release-assets/
          cp notebook-linux-x64/nteract-linux-x64.AppImage release-assets/
          # Updater bundles + signatures
          cp notebook-macos-arm64/nteract-darwin-arm64.app.tar.gz release-assets/ 2>/dev/null || true
          cp notebook-macos-arm64/nteract-darwin-arm64.app.tar.gz.sig release-assets/ 2>/dev/null || true
          cp notebook-windows-x64/nteract-windows-x64.nsis.zip release-assets/ 2>/dev/null || true
          cp notebook-windows-x64/nteract-windows-x64.nsis.zip.sig release-assets/ 2>/dev/null || true
          cp notebook-linux-x64/nteract-linux-x64.AppImage.sig release-assets/ 2>/dev/null || true

      - name: Generate updater manifest (latest.json)
        env:
          VERSION: ${{ needs.build-linux.outputs.version }}
          TAG_NAME: v${{ needs.build-linux.outputs.version }}
          REPO: ${{ github.repository }}
        run: |
          RELEASE_BASE="https://github.com/${REPO}/releases/download/${TAG_NAME}"
          PUB_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          read_sig() { cat "$1" 2>/dev/null || echo ""; }

          SIG_DARWIN_ARM64=$(read_sig release-assets/nteract-darwin-arm64.app.tar.gz.sig)
          SIG_LINUX_X64=$(read_sig release-assets/nteract-linux-x64.AppImage.sig)
          SIG_WINDOWS_X64=$(read_sig release-assets/nteract-windows-x64.nsis.zip.sig)

          jq -n \
            --arg version "$VERSION" \
            --arg notes "Preview release $TAG_NAME" \
            --arg pub_date "$PUB_DATE" \
            --arg sig_darwin_arm64 "$SIG_DARWIN_ARM64" \
            --arg url_darwin_arm64 "$RELEASE_BASE/nteract-darwin-arm64.app.tar.gz" \
            --arg sig_linux_x64 "$SIG_LINUX_X64" \
            --arg url_linux_x64 "$RELEASE_BASE/nteract-linux-x64.AppImage" \
            --arg sig_windows_x64 "$SIG_WINDOWS_X64" \
            --arg url_windows_x64 "$RELEASE_BASE/nteract-windows-x64.nsis.zip" \
            '{
              version: $version,
              notes: $notes,
              pub_date: $pub_date,
              platforms: {
                "darwin-aarch64": { signature: $sig_darwin_arm64, url: $url_darwin_arm64 },
                "linux-x86_64": { signature: $sig_linux_x64, url: $url_linux_x64 },
                "windows-x86_64": { signature: $sig_windows_x64, url: $url_windows_x64 }
              }
            }' > release-assets/latest.json

          echo "Generated latest.json:"
          cat release-assets/latest.json

      - name: Download Python wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: ./wheels
          merge-multiple: true

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Publish to PyPI
        continue-on-error: true
        run: uv publish --trusted-publishing always ./wheels/*.whl

      - name: Create GitHub Preview Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.build-linux.outputs.version }}
          name: nteract v${{ needs.build-linux.outputs.version }}
          body: |
            ## Weekly Preview Release

            Automated preview from `main`. **Commit:** ${{ github.sha }}

            ### nteract (desktop app)

            | Platform | Architecture | Download |
            |----------|--------------|----------|
            | macOS | ARM64 (Apple Silicon) | `nteract-darwin-arm64.dmg` |
            | Windows | x64 | `nteract-windows-x64.exe` |
            | Linux | x64 | `nteract-linux-x64.AppImage` |

            macOS builds are signed and notarized. Windows is not code signed — expect a SmartScreen prompt. Linux AppImage: `chmod +x` and run.

            This release includes auto-update support. Existing installations will be notified of this update automatically.

            ### runt (CLI)

            Also bundled inside the desktop app. Standalone binaries:

            | Platform | Architecture | Download |
            |----------|--------------|----------|
            | Linux | x64 | `runt-linux-x64` |
            | macOS | ARM64 | `runt-darwin-arm64` |

            ### runtimed (Python — macOS, Linux, Windows)

            ```bash
            pip install runtimed --pre
            ```
          draft: false
          prerelease: true
          files: |
            ./release-assets/runt-linux-x64
            ./release-assets/runt-darwin-arm64
            ./release-assets/nteract-linux-x64.AppImage
            ./release-assets/nteract-linux-x64.AppImage.sig
            ./release-assets/nteract-darwin-arm64.dmg
            ./release-assets/nteract-darwin-arm64.app.tar.gz
            ./release-assets/nteract-darwin-arm64.app.tar.gz.sig
            ./release-assets/nteract-windows-x64.exe
            ./release-assets/nteract-windows-x64.nsis.zip
            ./release-assets/nteract-windows-x64.nsis.zip.sig
            ./release-assets/latest.json
            ./wheels/*.whl

      - name: Update preview-latest updater channel
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Ensure the rolling preview-latest release exists, then update latest.json
          gh release create preview-latest \
            --title "Preview Update Channel" \
            --notes "Rolling release for the preview auto-update channel. This release always contains the latest updater manifest. Do not delete this release." \
            --prerelease 2>/dev/null || true

          gh release upload preview-latest release-assets/latest.json --clobber
