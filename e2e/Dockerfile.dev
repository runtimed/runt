# Dev mode Dockerfile - Uses pre-built base image for fast iteration
#
# Prerequisites:
#   docker build -f e2e/Dockerfile.base -t vienna-e2e-base .
#
# Usage:
#   docker compose --profile dev run --rm tauri-e2e-dev

FROM vienna-e2e-base

WORKDIR /app

# Copy package files for JS dependencies
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY apps/notebook/package.json apps/notebook/
COPY apps/sidecar/package.json apps/sidecar/
COPY packages/ packages/

# Install JS dependencies
RUN corepack enable && pnpm install --frozen-lockfile

# Copy source code (these layers change frequently)
COPY . .

# Build frontend assets
RUN pnpm run isolated-renderer:build
RUN pnpm --dir apps/notebook build

# Build Tauri app (incremental, uses cached deps from base image)
WORKDIR /app/crates/notebook
RUN cargo tauri build --ci --config '{"build":{"beforeBuildCommand":""}}'
WORKDIR /app

EXPOSE 4444 4445
