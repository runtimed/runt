services:
  # =============================================================================
  # E2E Tests: Build and run E2E tests in Docker
  # =============================================================================
  # Uses cargo-chef for Rust dependency caching â€” source-only changes skip
  # the expensive dependency build step. Release profile overrides disable
  # LTO for faster compilation.
  #
  # Usage:
  #   pnpm test:e2e:docker              # Build + run all tests
  #   docker compose run --rm tauri-e2e  # Same thing
  #
  tauri-e2e:
    platform: linux/amd64
    build:
      context: .
      dockerfile: e2e/Dockerfile
    volumes:
      # Mount e2e tests for live updates during development
      - ./e2e:/app/e2e:ro
      # Writable volume for screenshots
      - ./e2e-screenshots:/app/e2e-screenshots
    environment:
      - DISPLAY=:99
      - TAURI_APP_PATH=/app/target/release/notebook
    command: >
      bash -c "
        Xvfb :99 -screen 0 1920x1080x24 &
        sleep 2 &&
        DISPLAY=:99 tauri-driver --port 4444 &
        sleep 3 &&
        cd /app &&
        pnpm test:e2e
      "

  # =============================================================================
  # E2E Shell: Interactive debugging
  # =============================================================================
  # Starts container with Xvfb and tauri-driver running, drops you into a shell.
  # Useful for debugging test failures interactively.
  #
  # Usage:
  #   docker compose --profile dev run --rm tauri-e2e-shell
  #
  # Then inside container:
  #   pnpm test:e2e                    # Run all tests
  #   pnpm wdio run e2e/wdio.conf.js --spec e2e/specs/notebook-execution.spec.js
  #
  tauri-e2e-shell:
    platform: linux/amd64
    profiles: ["dev"]
    build:
      context: .
      dockerfile: e2e/Dockerfile
    volumes:
      - ./e2e:/app/e2e:ro
      - ./e2e-screenshots:/app/e2e-screenshots
    environment:
      - DISPLAY=:99
      - TAURI_APP_PATH=/app/target/release/notebook
    stdin_open: true
    tty: true
    command: >
      bash -c "
        Xvfb :99 -screen 0 1920x1080x24 &
        sleep 2 &&
        DISPLAY=:99 tauri-driver --port 4444 &
        sleep 3 &&
        echo '=== E2E Dev Shell ===' &&
        echo 'Run tests: pnpm test:e2e' &&
        echo 'Run single: pnpm wdio run e2e/wdio.conf.js --spec e2e/specs/notebook-execution.spec.js' &&
        echo '' &&
        bash
      "
