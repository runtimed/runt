services:
  # =============================================================================
  # CI Mode: Full isolated build (default)
  # =============================================================================
  # Used in CI pipelines. Builds everything from scratch for reproducibility.
  #
  # Usage:
  #   pnpm test:e2e:docker
  #   docker compose run --rm tauri-e2e
  #
  tauri-e2e:
    platform: linux/amd64
    build:
      context: .
      dockerfile: e2e/Dockerfile
    volumes:
      # Mount e2e tests for live updates during development
      - ./e2e:/app/e2e:ro
    environment:
      - DISPLAY=:99
      - TAURI_APP_PATH=/app/target/release/notebook
    command: >
      bash -c "
        Xvfb :99 -screen 0 1920x1080x24 &
        sleep 2 &&
        DISPLAY=:99 tauri-driver --port 4444 &
        sleep 3 &&
        cd /app &&
        pnpm test:e2e
      "

  # =============================================================================
  # Dev Mode: Fast iteration with cached base image
  # =============================================================================
  # Uses pre-built base image with dependencies cached. Much faster for
  # iterating on code changes.
  #
  # First time setup (run once, or when deps change):
  #   pnpm e2e:base:build
  #   docker build -f e2e/Dockerfile.base -t vienna-e2e-base .
  #
  # Usage:
  #   pnpm test:e2e:dev
  #   docker compose run --rm tauri-e2e-dev
  #
  tauri-e2e-dev:
    platform: linux/amd64
    profiles: ["dev"]
    build:
      context: .
      dockerfile: e2e/Dockerfile.dev
    volumes:
      # Mount e2e tests for live updates
      - ./e2e:/app/e2e:ro
    environment:
      - DISPLAY=:99
      - TAURI_APP_PATH=/app/target/release/notebook
    command: >
      bash -c "
        Xvfb :99 -screen 0 1920x1080x24 &
        sleep 2 &&
        DISPLAY=:99 tauri-driver --port 4444 &
        sleep 3 &&
        cd /app &&
        pnpm test:e2e
      "

  # =============================================================================
  # Dev Shell: Interactive debugging
  # =============================================================================
  # Starts container with Xvfb and tauri-driver running, drops you into a shell.
  # Useful for debugging test failures interactively.
  #
  # Usage:
  #   docker compose run --rm tauri-e2e-shell
  #
  # Then inside container:
  #   pnpm test:e2e                    # Run all tests
  #   pnpm wdio run e2e/wdio.conf.js --spec e2e/specs/notebook-execution.spec.js
  #
  tauri-e2e-shell:
    platform: linux/amd64
    profiles: ["dev"]
    build:
      context: .
      dockerfile: e2e/Dockerfile.dev
    volumes:
      - ./e2e:/app/e2e:ro
    environment:
      - DISPLAY=:99
      - TAURI_APP_PATH=/app/target/release/notebook
    stdin_open: true
    tty: true
    command: >
      bash -c "
        Xvfb :99 -screen 0 1920x1080x24 &
        sleep 2 &&
        DISPLAY=:99 tauri-driver --port 4444 &
        sleep 3 &&
        echo '=== E2E Dev Shell ===' &&
        echo 'Run tests: pnpm test:e2e' &&
        echo 'Run single: pnpm wdio run e2e/wdio.conf.js --spec e2e/specs/notebook-execution.spec.js' &&
        echo '' &&
        bash
      "
